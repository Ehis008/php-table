<?php 
session_start();
require "../config/db-connect.php";
$first_name=$_POST["first_name"];
$last_name=$_POST["last_name"];
$phone=$_POST["phone"];
$email=$_POST["email"];
$return_date=$_POST["return_date"];
$daily_rate=$_POST["daily_rate"];
$rental_date=date('Y-m-d');
$car_id=$_POST['car_id'];


$_SESSION["first_name"]=$first_name;
$_SESSION["last_name"]=$last_name;
$_SESSION["phone"]=$phone;
$_SESSION["email"]=$email;
$_SESSION["return_date"]=$return_date;
$_SESSION['user_input']=[
   'first_name'=> $first_name,
   'last_name'=>$last_name,
   'email'=>$email,
   'phone'=>$phone
];

if(empty ($first_name)){
   $_SESSION['error']="First name is required";
  header("Location:../car.php?id=$car_id");
  exit();
 }
 if(empty ($last_name)){
         $_SESSION['error']="Last name is required";
  header("Location:../car.php?id=$car_id");
  exit();
     }
 if(!filter_var($email, FILTER_VALIDATE_EMAIL)){
      $_SESSION['error']="Enter a valid email address";
  header("Location:../car.php?id=$car_id");
  exit();
    
 }
 if(!ctype_digit($phone)){
     $_SESSION['error']="Enter a valid phone number";
  header("Location:../car.php?id=$car_id");
  exit();
 }



 $rental_date_object= new DateTime($rental_date);
 $return_date_object = new DateTime($return_date);
 $interval= $rental_date_object->diff($return_date_object);
 $days= $interval->days;
 $total_cost= $days * $daily_rate;
 $sql= "SELECT * FROM customers WHERE email=?";
 $stmt= $pdo->prepare($sql);
 $stmt->execute([$email]);
 $customer=$stmt->fetch (PDO::FETCH_ASSOC);

 $sql = "SELECT make, model FROM cars WHERE id =?";
 $stmt = $pdo->prepare($sql);
 $stmt->execute([$car_id]);
 $car = $stmt->fetch(PDO::FETCH_ASSOC);



 if ($customer) {
    $customer_id = $customer['id'];
    $sql= "INSERT INTO rental (customer_id, car_id, rental_date, return_date, total_cost) VALUES (?,?,?,?,?)";
    $stmt= $pdo->prepare($sql);
    $stmt->execute([$customer_id,$car_id,$rental_date,$return_date,$total_cost]);

    $sql= "UPDATE cars SET `status` = 'rented' WHERE id= ?";
    $stmt=$pdo->prepare($sql);
    $stmt->execute([$car_id]);
    $_SESSION['success']= "You have successfully hired"." ".$car['make']. " ".$car['model'];
      header("Location:../cars.php");

 } else {
    $sql="INSERT INTO customers(first_name, last_name,phone,email) VALUES(?,?,?,?)";
    $stmt= $pdo->prepare($sql);
    $stmt->execute([$first_name,$last_name,$phone,$email]);

    $sql="SELECT * FROM customers WHERE email=?";
    $stmt=$pdo->prepare($sql);
    $stmt->execute([$email]);
    $customer=$stmt-> fetch(PDO:: FETCH_ASSOC);

    $customer_id=$customer["id"];

    $sql="INSERT INTO rental(customer_id, car_id, rental_date, return_date, total_cost) VALUES (?,?,?,?,?)";
    $stmt= $pdo->prepare($sql);
    $stmt->execute([$customer_id,$car_id,$rental_date,$return_date,$total_cost]);
    $sql= "UPDATE cars SET `status` = 'rented' WHERE id= ?";
    $stmt=$pdo->prepare($sql);
    $stmt->execute([$car_id]);

    $_SESSION['success']= "You have successfully hired a car";
      header("Location:../cars.php");
      }

?>





































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































